<div id="reg-header" class="row">
  <div class="col-md-2">
    <img src="images/letterhead.png" />
  </div>
  <div class="col-md-10">
    <h4>Student-Athlete Registration Form<br />Step 2 of 2</h4>
  </div>
</div>

<br />

<form role="form" method="post">

  <div class="panel panel-default">
    <div class="panel-heading">Student Information</div>
    <div class="panel-body">
      
      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
         <div class="form-group">
            <label for="studentNumber">Student #</label>
            <input id="reg-student-number" type="input" class="form-control" placeholder="">
          </div>
        </div>
        <div class="col-md-6">
         <div class="form-group">
            <label for="studentNumber">Email</label>
            <input id="reg-email" type="email" class="form-control" placeholder="">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">
        <div class="col-md-5">
          <div class="form-group">
            <label for="studentNumber">First Name</label>
            <input id="reg-first-name" type="input" class="form-control" placeholder="">
          </div>
        </div>
        <div class="col-md-5">
          <div class="form-group">
            <label for="studentNumber">Last Name</label>
            <input id="reg-last-name" type="input" class="form-control" placeholder="">
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label for="studentNumber">Initial(s)</label>
            <input id="reg-initials" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Gender</label>
            <select id="reg-gender" class="form-control">
              <option></option>
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="monthOfBirth">Date of Birth</label>
            <input id="reg-date-of-birth" type="input" class="form-control" placeholder="YYYY-MM-DD">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Height</label>
            <input id="reg-height" type="input" class="form-control" placeholder="ex. 5&#39;8&#34;">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Weight (lbs.)</label>
            <input id="reg-weight" type="input" class="form-control" placeholder="ex. 160">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">
        <div class="col-md-5">
          <div class="form-group">
            <label for="studentNumber">High School</label>
            <input id="reg-high-school" type="input" class="form-control" placeholder="">
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Year of Graduation</label>
            <input id="reg-year-of-graduation" type="input" class="form-control" placeholder="YYYY">
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="studentNumber">University Program</label>
            <input id="reg-program" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">Current Address</div>
    <div class="panel-body">

      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
         <div class="form-group">
            <label for="studentNumber">Street</label>
            <input id="reg-current-street" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">City</label>
            <input id="reg-current-city" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Province</label>
            <input id="reg-current-province" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="studentNumber">Phone</label>
            <input id="reg-current-phone" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Postal Code</label>
            <input id="reg-current-postal" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Country</label>
            <input id="reg-current-country" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">Permanent Address</div>
    <div class="panel-body">

      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
         <div class="form-group">
            <label for="studentNumber">Street</label>
            <input id="reg-permanent-street" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">City</label>
            <input id="reg-permanent-city" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Province</label>
            <input id="reg-permanent-province" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="studentNumber">Phone</label>
            <input id="reg-permanent-phone" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Postal Code</label>
            <input id="reg-permanent-postal" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label for="studentNumber">Country</label>
            <input id="reg-permanent-country" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">Athlete History</div>
    <div class="panel-body">

      <!-- new row -->
      <div class="row">
        <div class="col-md-6">
         <div class="form-group">
            <label for="studentNumber">UofL Team</label>
            <select id="reg-team-list" class="form-control">
              <!-- teams will be populated here from getTeams() -->
            </select>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label for="studentNumber">Team Name</label>
            <input id="reg-team-name" type="input" class="form-control" placeholder="">
          </div>
        </div>
      </div>

      <!-- new row -->
      <div class="row">
        <div class="col-md-3">
         <div class="form-group">
            <label for="studentNumber">Position</label>
            <input id="reg-team-position" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-3">
         <div class="form-group">
            <label for="studentNumber">Year</label>
            <input id="reg-team-year" type="input" class="form-control" placeholder="YYYY-YYYY">
          </div>
        </div>

        <div class="col-md-2">
          <div class="form-group">
            <label for="studentNumber">Jersey #</label>
            <input id="reg-team-jersey" type="input" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-md-2">
          <div class="form-group">
            <label for="studentNumber">Charged</label>
            <select id="reg-team-charged" class="form-control">
              <option>yes</option>
              <option>no</option>
            </select>
          </div>
        </div>

        <div class="col-md-1">
          <div class="form-group">
            <label for="studentNumber">&nbsp</label>
            <button id="reg-team-add-button" type="button" class="btn btn-primary">Add</button>
          </div>
        </div>
      </div>

      <table id="reg-team-table" class="table table-condensed">
        <thead>
          <tr>
            <td>Year</td>
            <td>Team</td>
            <td>Position</td>
            <td>Jersey</td>
            <td>Charged</td>
            <td> </td>
          </tr>
        </thead>
        <tbody id="reg-team-table-body"></body>
      </table>

      <!-- suspensions text area 
      <textarea id="reg-suspensions" class="form-control" rows="3" placeholder="Please indicate if you are presently under suspension from any sport organization or league."></textarea>
      -->
    </div>
  </div>

  <div id="reg-disclaimer" class="well">
    * The information collected in this form is used and disclosed by Canadian Interuniversity Sport("CIS") in accordance with the terms of CIS' Student Athlete Acknowledgement Form and CIS' Personal Information Protection Policy.<br />
    For further information about CIS' collection, use and disclosure of personal information, see our Personal Information Protection Policy at <a href="http://www.cis-sic.ca">www.cis-sic.ca</a>.
  </div>

  <!-- new row -->
  <div class='row'>
    <div class="col-md-8"></div>
    <div id="reg-buttons-1" class="col-md-2">
      <!-- populates with buttons depending on form type (register, verify, approve/delete) -->
    </div>
    <div id="reg-buttons-2" class="col-md-2">
      <!-- populates with buttons depending on form type (register, verify, approve/delete) -->
    </div>
  </div>

</form>

<script>

  var teamHistory = new Array(), // athletes team history
      teamList = new Array(), // uofl team list
      currentId = "000000000",
      formType = "reg";
      
  function init() {
    // get target studentId and form type from the URL
    currentId = cislib.getURLParameter("i");
    formType = cislib.getURLParameter("t");
    initializeForm();
  }

  function initializeForm() {
    // populate university team list on page and add appropriate buttons for form type
    cislib.managerRequest("team", "getList", undefined, populateTeamList);

    // disable ability to change studentId
    $("#reg-student-number").attr("disabled", "disabled");

    // event listener for select box
    $("#reg-team-list").change(teamSelectBoxChange);

    // button to add a team
    $("#reg-team-add-button").click(addTeamButtonClick);

    // hide team table
    $("#reg-team-table").css("display", "none");  

    switch (formType) {

      // registration form
      case "reg":
        $("#reg-student-number").val(currentId);
        $("#reg-buttons-2").html("<button id='reg-register-button' type='button' class='btn btn-lg btn-primary'>Register</button>");
        $("#reg-register-button").click(registerButtonClick);
        break;

      // verification form
      case "ver":
        $("#reg-header").css("display", "none");
        $("#reg-buttons-2").html("<button id='reg-verify-button' type='button' class='btn btn-lg btn-primary'>Verify</button>");
        $("#reg-verify-button").click(verifyButtonClick);
        cislib.managerRequest("form", "getAthlete", {id:currentId, queue:"no"}, populateKnownFields);
        break;

      // update form
      case "upd":
        $("#reg-header").css("display", "none");
        $("#reg-disclaimer").css("display", "none");
        $("#reg-buttons-2").html("<button id='reg-update-button' type='button' class='btn btn-lg btn-primary'>Update</button>");
        $("#reg-update-button").click(updateButtonClick);
        cislib.managerRequest("form", "getAthlete", {id:currentId, queue:"no"}, populateKnownFields);
        break;

      // approval form
      case "app":
        $("#reg-header").css("display", "none");
        $("#reg-disclaimer").css("display", "none");
        $("#reg-buttons-1").html("<button id='reg-approve-button' type='button' class='btn btn-lg btn-warning'>Approve</button>");
        $("#reg-buttons-2").html("<button id='reg-delete-button' type='button' class='btn btn-lg btn-danger'>Delete</button>");
        $("#reg-approve-button").click(approveButtonClick);
        $("#reg-delete-button").click(deleteButtonClick);
        cislib.managerRequest("form", "getAthlete", {id:currentId, queue:"yes"}, populateKnownFields);
        break;
    }
  }

  function populateKnownFields(result) {
    var infoPrefix = result[0],
        info = result[1];
    $("#reg-student-number").val(info[infoPrefix + "studentId"]);
    $("#reg-email").val(info[infoPrefix + "email"]);
    $("#reg-last-name").val(info[infoPrefix + "lastName"]);
    $("#reg-first-name").val(info[infoPrefix + "firstName"]);
    $("#reg-initials").val(info[infoPrefix + "initials"]);
    $("#reg-gender").val(info[infoPrefix + "gender"]);
    $("#reg-date-of-birth").val(info[infoPrefix + "dob"]);
    $("#reg-height").val(info[infoPrefix + "height"]);
    $("#reg-weight").val(info[infoPrefix + "weight"]);
    $("#reg-high-school").val(info[infoPrefix + "highSchool"]);
    $("#reg-year-of-graduation").val(info[infoPrefix + "gradYear"]);
    $("#reg-program").val(info[infoPrefix + "program"]);

    $("#reg-current-street").val(info[infoPrefix + "cStreet"]);
    $("#reg-current-city").val(info[infoPrefix + "cCity"]);
    $("#reg-current-province").val(info[infoPrefix + "cProvince"]);
    $("#reg-current-postal").val(info[infoPrefix + "cPostalCode"]);
    $("#reg-current-country").val(info[infoPrefix + "cCountry"]);
    $("#reg-current-phone").val(info[infoPrefix + "cPhone"]);

    $("#reg-permanent-street").val(info[infoPrefix + "pStreet"]);
    $("#reg-permanent-city").val(info[infoPrefix + "pCity"]);
    $("#reg-permanent-province").val(info[infoPrefix + "pProvince"]);
    $("#reg-permanent-postal").val(info[infoPrefix + "pPostalCode"]);
    $("#reg-permanent-country").val(info[infoPrefix + "pCountry"]);
    $("#reg-permanent-phone").val(info[infoPrefix + "pPhone"]);

    // add teams to js array
    var histPrefix = result[2];
    for (var i = 3; i < result.length; i++) {
      addTeam(
        result[i][histPrefix + "year"],
        result[i][histPrefix + "teamId"],
        result[i][histPrefix + "teamName"],
        result[i][histPrefix + "position"],
        result[i][histPrefix + "jerseyNumber"],
        result[i][histPrefix + "charged"]
      );
    }
  }

  function populateTeamList(result) {
    var htmlString = "<option>Non-UofL Team</option>";
    for (var i = 0; i < result.length; i++) {
      teamList.push({
        id   : result[i].t_id,
        name : result[i].t_name
      });
      htmlString += "<option>" + result[i].t_name + "</option>";
    }
    $("#reg-team-list").html(htmlString);
  }

  // == team history ==

  function addTeam(year, teamId, teamName, position, jersey, charged) {

    // format charged
    if (charged == "1")
      charged = "yes";
    else if (charged == "0")
      charged = "no";

    // add team to memory
    teamHistory.push({
      year     : year,
      teamId   : teamId,
      teamName : teamName,
      position : position,
      jersey   : jersey,
      charged  : charged
    });

    // create a table entry
    var tableString = "<tr id='reg-team-row-" + year + "'>";
        tableString += "<td>" + year + "-" + (parseInt(year) + 1) + "</td>";
        tableString += "<td>" + teamName + "</td>";
        tableString += "<td>" + position + "</td>";
        tableString += "<td>" + jersey + "</td>";
        tableString += "<td>" + charged + "</td>";
        tableString += "<td><button id='reg-team-remove-" + year + "' type='button' class='btn btn-xs btn-primary'>remove</button></td>";
        tableString += "</tr>";
    $("#reg-team-table-body").append(tableString);
    $("#reg-team-remove-" + year).click(removeTeamButtonClick);

    // make the team table visible
    $("#reg-team-table").css("display", "block");
  }

  function removeTeam(year) {
    for (var i = 0; i < teamHistory.length; i++)
      if (teamHistory[i].year == year)
        teamHistory.splice(i, 1);

    // remove the table entry
    $("#reg-team-row-" + year).remove();

    // remove table if empty
    if (teamHistory.length == 0)
      $("#reg-team-table").css("display", "none");
  }

  function teamSelectBoxChange(event) {
    if (event.target.value == "Non-UofL Team") {
      $("#reg-team-name").val("");
      $("#reg-team-name").removeAttr("disabled");
    } else {
      $("#reg-team-name").val(event.target.value);
      $("#reg-team-name").attr("disabled", "disabled");
    }
  }

  function getSelectedTeamId() {
    var selectedTeam = $("#reg-team-name").val();
    for (var i = 0; i < teamList.length; i++)
      if (teamList[i].name == selectedTeam)
        return teamList[i].id;
    return 0;
  }

  function getTeamByYear(year) {
    for (var i = 0; i < teamHistory.length; i++)
      if (teamHistory[i].year == year)
        return teamHistory[i];
    return undefined;
  }

  // == button event listeners ==

   function addTeamButtonClick(event) {
    // !!! validate input
    var years = $( "#reg-team-year" ).val().split("-"),
        startYear = years[0],
        endYear = years[1],
        teamId = getSelectedTeamId(),
        teamName = $( "#reg-team-name" ).val(),
        position = $( "#reg-team-position" ).val(),
        jersey = $( "#reg-team-jersey" ).val(),
        charged = $( "#reg-team-charged" ).val();

    // send team to server
    var teamObject = {
      queue     : (formType == "reg" || formType == "app") ? "yes" : "no",
      studentId : currentId,
      year      : startYear,
      teamId    : teamId,
      teamName  : teamName,
      position  : position,
      jersey    : jersey,
      charged   : charged
    };
    cislib.managerRequest("form", "addTeam", teamObject, function(result) {
      addTeam(result['year'], result['teamId'], result['teamName'], result['position'], result['jersey'], result['charged']);
    });
  }

  function removeTeamButtonClick(event) {
    $("#" + event.target.id).unbind();

    var year = event.target.id.substr(16);
    var teamObject = {
      queue     : (formType == "reg" || formType == "app") ? "yes" : "no",
      studentId : currentId,
      year      : year
    };
    cislib.managerRequest("form", "removeTeam", teamObject, function(result) {
      removeTeam(result.year);
    });
  }

  function registerButtonClick(event) {
    var athleteObject = getAthleteObject();
    cislib.managerRequest("form", "register", athleteObject, function(result) {
      if (result)
        window.location.href = "?n=regs";
      else
        window.location.href = "?n=regf";
    });
  }

  function verifyButtonClick(event) {

  }

  function updateButtonClick(event) {
    var athleteObject = getAthleteObject();
    cislib.managerRequest("form", "update", athleteObject, function(result) {
      if (result)
        window.location.href = "?p=srch&r=upds";
      else
        window.location.href = "?p=srch&r=updf";
    });
  }

  function approveButtonClick(event) {
    var athleteObject = getAthleteObject();
    cislib.managerRequest("form", "approve", athleteObject, function(result) {
      if (result)
        window.location.href = "?p=inbx&r=app";
      else
        window.location.href = "?p=inbx&r=appf";
    });
  }

  function deleteButtonClick(event) {
    if (event.target.innerHTML == "Delete") {
      event.target.innerHTML = "Confirm";
    } else {
      cislib.managerRequest("form", "delete", currentId, function(result) {
        if (result)
          window.location.href = "?p=inbx&r=del";
        else
          window.location.href = "?p=inbx&r=delf";
      });
    }
  }

  function getAthleteObject() {
    // store the information as an object
    return {
      studentId  : $("#reg-student-number").val(),
      lastName   : $("#reg-last-name").val(),
      firstName  : $("#reg-first-name").val(),
      initials   : $("#reg-initials").val(),
      gender     : $("#reg-gender").val(),
      dob        : $("#reg-date-of-birth").val(),
      height     : $("#reg-height").val(),
      weight     : $("#reg-weight").val(),
      email      : $("#reg-email").val(),
      highSchool : $("#reg-high-school").val(),
      gradYear   : $("#reg-year-of-graduation").val(),
      program    : $("#reg-program").val(),

      cStreet    : $("#reg-current-street").val(),
      cCity      : $("#reg-current-city").val(),
      cProvince  : $("#reg-current-province").val(),
      cPostal    : $("#reg-current-postal").val(),
      cCountry   : $("#reg-current-country").val(),
      cPhone     : $("#reg-current-phone").val(),

      pStreet    : $("#reg-permanent-street").val(),
      pCity      : $("#reg-permanent-city").val(),
      pProvince  : $("#reg-permanent-province").val(),
      pPostal    : $("#reg-permanent-postal").val(),
      pCountry   : $("#reg-permanent-country").val(),
      pPhone     : $("#reg-permanent-phone").val()
    };
  }

  init();

  /*
  var studentId = $("#reg-student-number").val(),
      email = $("#reg-email").val(),
      lastName = $("#reg-last-name").val(),
      firstName = $("#reg-first-name").val(),
      initials = $("#reg-initials").val(),
      gender = $("#reg-gender").val(),
      dob = $("#reg-date-of-birth").val(),
      height = $("#reg-height").val(),
      weight = $("#reg-weight").val(),
      highSchool = $("#reg-high-school").val(),
      gradYear = $("#reg-year-of-graduation").val(),
      program = $("#reg-program").val(),

      cStreet = $("#reg-current-street").val(),
      cCity = $("#reg-current-city").val(),
      cProvince = $("#reg-current-province").val(),
      cPostal = $("#reg-current-postal").val(),
      cCountry = $("#reg-current-country").val(),
      cPhone = $("#reg-current-phone").val(),

      pStreet = $("#reg-permanent-street").val(),
      pCity = $("#reg-permanent-city").val(),
      pProvince = $("#reg-permanent-province").val(),
      pPostal = $("#reg-permanent-postal").val(),
      pCountry = $("#reg-permanent-country").val(),
      pPhone = $("#reg-permanent-phone").val();
  */

</script>